/*
UploadiFive 1.0.1
Copyright (c) 2012 Reactive Apps, Ronnie Garcia
Released under the UploadiFive Standard License <http://www.uploadify.com/uploadifive-standard-license>
*/
;(function(b){var a={init:function(c){return this.each(function(){var g=b(this);g.data("uploadifive",{inputs:{},inputCount:0,fileID:0,queue:{count:0,selected:0,replaced:0,errors:0,queued:0,cancelled:0},uploads:{current:0,attempts:0,successful:0,errors:0,count:0}});var d=g.data("uploadifive");var f=d.settings=b.extend({auto:true,buttonClass:false,buttonText:"Select Files",checkScript:false,dnd:true,fileSizeLimit:0,fileType:false,formData:{},height:30,method:"post",multi:true,overrideEvents:[],queueID:false,queueSizeLimit:0,removeCompleted:false,simUploadLimit:0,truncateLength:0,uploadLimit:0,uploadScript:"uploadifive.php",width:100,},c);if(isNaN(f.fileSizeLimit)){var e=parseInt(f.fileSizeLimit)*1.024;if(f.fileSizeLimit.indexOf("KB")>-1){f.fileSizeLimit=e*1000;}if(f.fileSizeLimit.indexOf("MB")>-1){f.fileSizeLimit=e*1000000;}if(f.fileSizeLimit.indexOf("GB")>-1){f.fileSizeLimit=e*1000000000;}}else{f.fileSizeLimit=f.fileSizeLimit*1024;}d.inputTemplate=b('<input type="file">').css({opacity:0,position:"absolute","z-index":999});d.createInput=function(){var h=d.inputTemplate.clone();var j=h.name="input"+d.inputCount++;if(f.multi){h.attr("multiple",true);}h.bind("change",function(){d.queue.selected=0;d.queue.replaced=0;d.queue.errors=0;d.queue.queued=0;var k=this.files.length;d.queue.selected=k;if((d.queue.count+k)>f.queueSizeLimit&&f.queueSizeLimit!==0){if(b.inArray("onError",f.overrideEvents)<0){alert("The maximum number of queue items has been reached ("+f.queueSizeLimit+").  Please select fewer files.");}if(typeof f.onError==="function"){f.onError.call(g,"QUEUE_LIMIT_EXCEEDED");}}else{for(var l=0;l<k;l++){file=this.files[l];d.addQueueItem(file);}d.inputs[j]=this;d.createInput();}if(f.auto){a.upload.call(g);}if(typeof f.onSelect==="function"){f.onSelect.apply(g,d.queue);}});if(d.currentInput){d.currentInput.hide();}d.button.append(h);d.currentInput=h;};d.destroyInput=function(h){b(d.inputs[h]).remove();delete d.inputs[h];d.inputCount--;};d.drop=function(l){d.queue.selected=0;d.queue.replaced=0;d.queue.errors=0;d.queue.queued=0;var k=l.dataTransfer;var j=k.name="input"+d.inputCount++;var h=k.files.length;d.queue.selected=h;if((d.queue.count+h)>f.queueSizeLimit&&f.queueSizeLimit!==0){if(b.inArray("onError",f.overrideEvents)<0){alert("The maximum number of queue items has been reached ("+f.queueSizeLimit+").  Please select fewer files.");}if(typeof f.onError==="function"){f.onError.call(g,"QUEUE_LIMIT_EXCEEDED");}}else{for(var m=0;m<h;m++){file=k.files[m];d.addQueueItem(file);}d.inputs[j]=k;}if(f.auto){a.upload.call(g);}if(typeof f.onDrop==="function"){f.onDrop.call(g,k.files,k.files.length);}l.preventDefault();l.stopPropagation();};d.fileExistsInQueue=function(j){for(var h in d.inputs){input=d.inputs[h];limit=input.files.length;for(var k=0;k<limit;k++){existingFile=input.files[k];if(existingFile.name==j.name&&!existingFile.complete){return true;}}}return false;};d.removeExistingFile=function(j){for(var h in d.inputs){input=d.inputs[h];limit=input.files.length;for(var k=0;k<limit;k++){existingFile=input.files[k];if(existingFile.name==j.name&&!existingFile.complete){d.queue.replaced++;a.cancel.call(g,existingFile,true);}}}};d.queueItem=b('<div class="uploadifive-queue-item">                    <a class="close" href="#">X</a>                    <div><span class="filename"></span><span class="fileinfo"></span></div>                    <div class="progress">                        <div class="progress-bar"></div>                    </div>                </div>');d.addQueueItem=function(h){if(b.inArray("onAddQueueItem",f.overrideEvents)<0){d.removeExistingFile(h);h.queueItem=d.queueItem.clone();h.queueItem.attr("id",f.id+"-file-"+d.fileID++);h.queueItem.find(".close").bind("click",function(){a.cancel.call(g,h);return false;});var l=h.name;if(l.length>f.truncateLength&&f.truncateLength!=0){l=l.substring(0,f.truncateLength)+"...";}h.queueItem.find(".filename").html(l);h.queueItem.data("file",h);d.queueEl.append(h.queueItem);}if(typeof f.onAddQueueItem==="function"){f.onAddQueueItem.call(g,h);}if(f.fileType){if(b.isArray(f.fileType)){var j=false;for(var k=0;k<f.fileType.length;k++){if(h.type.indexOf(f.fileType[k])>-1){isValidFileType=true;}}if(!isValidFileType){d.error("FORBIDDEN_FILE_TYPE",h);}}else{if(h.type.indexOf(f.fileType)<0){d.error("FORBIDDEN_FILE_TYPE",h);}}}if(h.size>f.fileSizeLimit&&f.fileSizeLimit!=0){d.error("FILE_SIZE_LIMIT_EXCEEDED",h);}else{d.queue.queued++;d.queue.count++;}};d.removeQueueItem=function(l,k,j){if(!j){j=0;}var h=k?0:500;if(l.queueItem){if(l.queueItem.find(".fileinfo").html()!=" - Completed"){l.queueItem.find(".fileinfo").html(" - Cancelled");}l.queueItem.find(".progress-bar").width(0);l.queueItem.delay(j).fadeOut(h,function(){b(this).remove();});delete l.queueItem;d.queue.count--;}};d.filesToUpload=function(){var j=0;for(var h in d.inputs){input=d.inputs[h];limit=input.files.length;for(var k=0;k<limit;k++){file=input.files[k];if(!file.skip&&!file.complete){j++;}}}return j;};d.checkExists=function(h){if(b.inArray("onCheck",f.overrideEvents)<0){b.ajaxSetup({async:false});b.post(f.checkScript,{filename:h.name},function(j){h.exists=parseInt(j);});if(h.exists){if(!confirm("A file named "+h.name+" already exists in the upload folder.\nWould you like to replace it?")){a.cancel.call(g,h);return true;}}}if(typeof f.onCheck==="function"){f.onCheck.call(g,h,h.exists);}return false;};d.uploadFile=function(k,l){if(!k.skip&&!k.complete&&!k.uploading){k.uploading=true;d.uploads.current++;d.uploads.attempted++;var h=new FileReader();h.readAsDataURL(k);xhr=k.xhr=new XMLHttpRequest();xhr.upload.addEventListener("progress",function(n){d.progress(n,k);},false);xhr.addEventListener("load",function(o){k.uploading=false;var n=this.status;if(n==404){d.error("404_FILE_NOT_FOUND",k,l);}else{d.uploadComplete(o,k,l);}},false);var j=f.uploadScript;if(f.method=="get"){var m=b(f.formData).param();j+=m;}xhr.open(f.method,f.uploadScript,true);if(b.inArray("onUploadFile",f.overrideEvents)<0){xhr.setRequestHeader("Content-Type","multipart/form-data");xhr.setRequestHeader("X_FILE_NAME",k.name);xhr.setRequestHeader("X_FILE_SIZE",k.size);xhr.setRequestHeader("X_FILE_TYPE",k.type);for(key in f.formData){xhr.setRequestHeader("X_"+key,f.formData[key]);}}if(typeof f.onUploadFile==="function"){f.onUploadFile.call(g,k);}xhr.send(k);}};d.progress=function(k,h){if(b.inArray("onProgress",f.overrideEvents)<0){if(k.lengthComputable){var j=Math.round((k.loaded/k.total)*100);}h.queueItem.find(".fileinfo").html(" - "+j+"%");h.queueItem.find(".progress-bar").css("width",j+"%");}if(typeof f.onProgress==="function"){f.onProgress.call(g,h,k);}};d.error=function(k,h,j){if(b.inArray("error",f.overrideEvents)<0){h.queueItem.addClass("error").find(".fileinfo").html(" - "+k);h.queueItem.find(".progress").remove();}if(typeof f.onError==="function"){f.onError.call(g,k,h);}h.skip=true;if(k=="404_FILE_NOT_FOUND"){d.uploads.errors++;}else{d.queue.errors++;}if(j){a.upload.call(g,null,true);}};d.uploadComplete=function(k,h,j){if(b.inArray("onUploadComplete",f.overrideEvents)<0){h.queueItem.find(".progress-bar").css("width","100%");h.queueItem.find(".fileinfo").html(" - Completed");h.queueItem.find(".progress").slideUp(250);h.queueItem.addClass("complete");}if(typeof f.onUploadComplete==="function"){f.onUploadComplete.call(g,h,h.xhr.responseText);}if(f.removeCompleted){setTimeout(function(){a.cancel.call(g,h);},3000);}h.complete=true;d.uploads.successful++;d.uploads.count++;d.uploads.current--;delete h.xhr;if(j){a.upload.call(g,null,true);}};d.queueComplete=function(){if(typeof f.onQueueComplete==="function"){f.onQueueComplete.call(g,d.uploads);}};if(window.File&&window.FileList&&window.FileReader&&window.Blob){f.id="uploadifive-"+g.attr("id");d.button=b('<div id="'+f.id+'" class="uploadifive-button">'+f.buttonText+"</div>");if(f.buttonClass){d.button.addClass(f.buttonClass);}d.button.css({height:f.height,"line-height":f.height+"px",overflow:"hidden",position:"relative","text-align":"center",width:f.width});g.before(d.button).appendTo(d.button).hide();d.createInput.call(g);d.button.mousemove(function(h){var j=d.button.offset();d.currentInput.css({left:h.pageX-j.left-g.width()+10,top:h.pageY-j.top-g.height()+10});});if(!f.queueID){f.queueID=f.id+"-queue";d.queueEl=b('<div id="'+f.queueID+'" class="uploadifive-queue" />');d.button.after(d.queueEl);}else{d.queueEl=b("#"+f.queueID);}if(f.dnd){d.queueEl.get(0).addEventListener("dragleave",function(h){h.preventDefault();h.stopPropagation();},false);d.queueEl.get(0).addEventListener("dragenter",function(h){h.preventDefault();h.stopPropagation();},false);d.queueEl.get(0).addEventListener("dragover",function(h){h.preventDefault();h.stopPropagation();},false);d.queueEl.get(0).addEventListener("drop",d.drop,false);}if(typeof f.onInit==="function"){f.onInit.call(g);}}else{if(typeof f.onFallback==="function"){f.onFallback.call(g);}return false;}});},debug:function(){return this.each(function(){console.log(b(this).data("uploadifive"));});},clearQueue:function(){this.each(function(){var f=b(this),c=f.data("uploadifive"),e=c.settings;for(var d in c.inputs){input=c.inputs[d];limit=input.files.length;for(i=0;i<limit;i++){file=input.files[i];a.cancel.call(f,file);}}if(typeof e.onClearQueue==="function"){e.onClearQueue.call(f,b("#"+c.options.queueID));}});},cancel:function(d,c){this.each(function(){var g=b(this),e=g.data("uploadifive"),f=e.settings;if(typeof d==="string"){if(!isNaN(d)){fileID="uploadifive-"+b(this).attr("id")+"-file-"+d;}d=b("#"+fileID).data("file");}d.skip=true;e.filesCancelled++;if(d.uploading){e.uploads.current--;d.uploading=false;d.xhr.abort();delete d.xhr;a.upload.call(g);}if(b.inArray("onCancel",f.overrideEvents)<0){e.removeQueueItem(d,c);}if(typeof f.onCancel==="function"){f.onCancel.call(g,d);}});},upload:function(c,d){this.each(function(){var h=b(this),e=h.data("uploadifive"),f=e.settings;if(c){e.uploadFile.call(h,c);}else{if((e.uploads.count+e.uploads.current)<f.uploadLimit||f.uploadLimit==0){if(!d){e.uploads.attempted=0;e.uploads.successsful=0;e.uploads.errors=0;var g=e.filesToUpload();if(typeof f.onUpload==="function"){f.onUpload.call(h,g);}}b("#"+f.queueID).find(".uploadifive-queue-item").not(".error, .complete").each(function(){_file=b(this).data("file");if((e.uploads.current>=f.simUploadLimit&&f.simUploadLimit!==0)||(e.uploads.current>=f.uploadLimit&&f.uploadLimit!==0)||(e.uploads.count>=f.uploadLimit&&f.uploadLimit!==0)){return false;}if(f.checkScript){_file.checking=true;skipFile=e.checkExists(_file);_file.checking=false;if(!skipFile){e.uploadFile(_file,true);}}else{e.uploadFile(_file,true);}});if(b("#"+f.queueID).find(".uploadifive-queue-item").not(".error, .complete").size()==0){e.queueComplete();}}else{if(e.uploads.current==0){if(b.inArray("onError",f.overrideEvents)<0){if(e.filesToUpload()>0&&f.uploadLimit!=0){alert("The maximum upload limit has been reached.");}}if(typeof f.onError==="function"){f.onError.call(h,"UPLOAD_LIMIT_EXCEEDED",e.filesToUpload());}}}}});},destroy:function(){this.each(function(){var e=b(this),c=e.data("uploadifive"),d=c.settings;a.clearQueue.call(e);if(!d.queueID){b("#"+d.queueID).remove();}e.siblings("input").remove();e.show().insertBefore(c.button);c.button.remove();if(typeof d.onDestroy==="function"){d.onDestroy.call(e);}});}};b.fn.uploadifive=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1));}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments);}else{b.error("The method "+c+" does not exist in $.uploadify");}}};})(jQuery);